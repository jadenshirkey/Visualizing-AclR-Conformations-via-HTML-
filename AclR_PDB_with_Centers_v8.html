<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AclR — PDB + Centers (v8)</title>
<style>
  html, body { height:100%; margin:0; }
  body { background:#0b0f14; color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .bar { display:flex; gap:10px; align-items:center; padding:10px 12px; border-bottom:1px solid #1f2937; flex-wrap:wrap; }
  select, button, label, input { font-size:14px; }
  select, button { background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:6px 8px; }
  button:hover { background:#1f2937; border-color:#4b5563; }
  button:active { background:#0f172a; transform:translateY(1px); }
  button.button-active { background:#60a5fa; border-color:#3b82f6; transform:scale(0.95); }
  label { display:inline-flex; align-items:center; gap:6px; }
  #viewer { position:relative; height: calc(100vh - 52px); }
  .status { position:absolute; left:10px; top:10px; font-size:12px; background:rgba(17,24,39,.85); border:1px solid #374151; border-radius:8px; padding:6px 8px; }
  .legend { position:absolute; left:87.5%; top:50%; transform:translate(-50%, -50%); font-size:18px; background:rgba(17,24,39,.92); border:1px solid #374151; border-radius:12px; padding:20px 24px; cursor:move; min-width:300px; user-select:none; z-index:100; transition:opacity 0.3s ease, visibility 0.3s ease; }
  .legend.hidden { opacity:0; visibility:hidden; pointer-events:none; }
  .legend-toggle { position:absolute; left:87.5%; top:10px; transform:translateX(-50%); background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:8px 16px; font-size:14px; font-weight:500; cursor:pointer; user-select:none; transition:all 0.2s ease; z-index:1000; display:flex; align-items:center; gap:6px; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
  .legend-toggle:hover { background:#1f2937; border-color:#4b5563; transform:translateX(-50%) translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.4); }
  .legend-toggle:active { transform:translateX(-50%) translateY(0); box-shadow:0 2px 6px rgba(0,0,0,0.3); }
  .legend-toggle::before { content:'▼'; font-size:10px; transition:transform 0.3s ease; }
  .legend-toggle.collapsed::before { transform:rotate(-90deg); }
  .legend-toggle:focus { outline:2px solid #60a5fa; outline-offset:2px; }
  .legend-toggle:focus:not(:focus-visible) { outline:none; }
  @media (max-width:767px) {
    .legend { left:50%; top:auto; bottom:10px; transform:translate(-50%, 0); font-size:16px; padding:16px 20px; min-width:280px; max-width:calc(100vw - 20px); max-height:40vh; overflow-y:auto; }
    .legend > div { margin:4px 0; }
    .legend::-webkit-scrollbar { width:6px; }
    .legend::-webkit-scrollbar-track { background:rgba(55,65,81,0.3); border-radius:3px; }
    .legend::-webkit-scrollbar-thumb { background:rgba(96,165,250,0.5); border-radius:3px; }
    .legend::-webkit-scrollbar-thumb:hover { background:rgba(96,165,250,0.7); }
    .legend-toggle { left:auto; right:10px; top:10px; transform:none; font-size:12px; padding:6px 12px; }
    .legend-toggle:hover { transform:translateY(-2px); }
    .legend-toggle:active { transform:translateY(0); }
  }
  @media (max-width:479px) {
    .legend { left:10px; right:10px; width:auto; min-width:unset; transform:none; font-size:14px; padding:12px 16px; max-height:35vh; line-height:1.4; }
    .legend b { font-size:15px; }
    .legend span[style*="width:10px"] { width:8px !important; height:8px !important; }
  }
  @media (max-width:767px) and (orientation:landscape) {
    .legend { max-height:50vh; font-size:14px; padding:12px 16px; }
  }
</style>
<script src="3Dmol-min.js"></script>
</head>
<body>
<div class="bar">
  <b style="opacity:.9">AclR:</b>
  <label>State
    <select id="state">
      <option value="APO_AA'">APO (AA')</option>
      <option value="APO_BC">APO (BC)</option>
      <option value="LIGAND_OFF" selected>+LIG, OFF</option>
      <option value="LIGAND_ON">+LIG, ON</option>
    </select>
  </label>
  <label><input type="checkbox" id="showPDB" checked> Show PDB</label>
  <label><input type="checkbox" id="fastMode"> Fast mode (trace)</label>
  <label><input type="checkbox" id="showCenters"> Show centers</label>
  <label><input type="checkbox" id="showSidechains" checked> Sidechains</label>
  <label><input type="checkbox" id="showLabels"> Labels</label>
  <label><input type="checkbox" id="spin" checked> Spin</label>
  <button id="reset">Reset view</button>
  <span style="opacity:.65;font-size:12px">Place <code>3Dmol-min.js</code> next to this file for offline use.</span>
</div>
<div id="viewer"></div>
<script>
(function(){
  function ensure(cb){
    if (window.$3Dmol) return cb();
    var s=document.createElement('script');
    s.src="https://unpkg.com/3dmol@2.0.4/build/3Dmol-min.js";
    s.onload=cb;
    document.head.appendChild(s);
  }
  ensure(init);

  function init(){
    const PDBS = {/* PDB strings omitted here for brevity in this snippet —
                     keep your existing PDBS object exactly as in your file */};

    const RAW_CENTERS = {/* centers data here, unchanged */};

    const CHAIN_A = 0x800000; // maroon
    const CHAIN_B = 0xffffff; // white
    const YELLOW  = 0xFFD700; // Tyr44
    const LIME    = 0x32CD32; // Phe62
    const RED     = 0xFF0000; // Ser57
    const DASH_GRAY = 0x9ca3af;

    let state = "LIGAND_OFF";
    const el = (id)=>document.getElementById(id);
    const viewer = $3Dmol.createViewer('viewer', {
      backgroundColor: 'black',
      antialias: false,
      disableFog: true,
    });
    let baselineView = null;

    const status = document.createElement('div');
    status.className = 'status';
    document.getElementById('viewer').appendChild(status);

    const legend = document.createElement('div');
    legend.className = 'legend';
    legend.innerHTML = `
      <div><b>PROTOMERS:</b></div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#800000;margin-right:6px;"></span>Chain A</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#ffffff;border:1px solid #ccc;box-sizing:border-box;margin-right:6px;"></span>Chain B</div>
      <div><b>RESIDUES:</b></div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#ffd700;margin-right:6px;"></span>Tyr44</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#ff0000;margin-right:6px;"></span>Ser57</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#32cd32;margin-right:6px;"></span>Phe62</div>
      <div style="margin-top:6px;opacity:.75;">Ligand: C8-Acyl-Cyclo-Lysine</div>`;
    document.getElementById('viewer').appendChild(status);

    const legendToggle = document.createElement('button');
    legendToggle.className = 'legend-toggle';
    legendToggle.textContent = 'Legend';
    document.body.appendChild(legendToggle);
    document.getElementById('viewer').appendChild(legend);
    // ... legend drag/toggle logic unchanged ...

    function isMobileView(){
      return window.innerWidth < 768;
    }

    function applyMobileViewAdjustments(){
      if (!isMobileView()) return;
      viewer.translate(0, -10, 0);
      viewer.zoom(1.1);
    }

    function showProtein(model){
      if (el('fastMode').checked) {
        model.setStyle({chain:'A'}, {line: { color: CHAIN_A, linewidth: 2 }});
        model.setStyle({chain:'B'}, {line: { color: CHAIN_B, linewidth: 2 }});
        model.setStyle({chain:'A', backbone:true}, {stick: { radius: 0.08, color: CHAIN_A, opacity: 0.95 }});
        model.setStyle({chain:'B', backbone:true}, {stick: { radius: 0.08, color: CHAIN_B, opacity: 0.95 }});
      } else {
        model.setStyle({chain:'A'}, {cartoon: { color: CHAIN_A, opacity: 0.98 }});
        model.setStyle({chain:'B'}, {cartoon: { color: CHAIN_B, opacity: 0.98 }});
      }
      // Ligand ball-and-stick (CPK)
      model.setStyle({resn:'LIG'}, {stick: { radius: 0.25 }, sphere: { radius: 0.55 }});
    }

    function showSidechains(model){
      // Explicit residues: Tyr44 (yellow), Ser57 (red), Phe62 (lime)
      // Use addStyle so we KEEP the underlying cartoon/trace.
      model.addStyle({ resi: 44 }, { stick: { radius: 0.28, color: YELLOW } }); // Tyr44
      model.addStyle({ resi: 57 }, { stick: { radius: 0.28, color: RED } });    // Ser57
      model.addStyle({ resi: 62 }, { stick: { radius: 0.28, color: LIME } });   // Phe62
      // Optional additional sidechain styling (commented):
      // model.addStyle({chain:'A', resi: [58,59,60,61]}, {stick: { radius: 0.24, color: CHAIN_A }});
      // model.addStyle({chain:'B', resi: [58,59,60,61]}, {stick: { radius: 0.24, color: CHAIN_B }});
      // model.addStyle({byres:true, within: {distance: 4.0, sel: {resn:'LIG'}}},
      //                {stick: { radius: 0.20, opacity: 1.0 }});
    }

    function labelAt(text, p){
      if (!el('showLabels').checked) return;

      // Split labels like "DNA Binding Domain [Protomer 1]"
      const protomerMatch = text.match(/^(.+?)\s+(\[Protomer \d+\])$/);
      const dy = 1.5; // adjusted spacing so labels appear on two lines without excessive gap

      if (protomerMatch) {
        // Line 1: domain name (above)
        viewer.addLabel(protomerMatch[1], {
          position: { x: p.x, y: p.y + dy, z: p.z },
          backgroundOpacity: 0.6,
          fontSize: 16
        });
        // Line 2: [Protomer X] (below)
        viewer.addLabel(protomerMatch[2], {
          position: { x: p.x, y: p.y - dy, z: p.z },
          backgroundOpacity: 0.6,
          fontSize: 14
        });
      } else {
        viewer.addLabel(text, {
          position: p,
          backgroundOpacity: 0.6,
          fontSize: 16
        });
      }
    }

    function distanceLabelAt(text, p){
      // Distance labels should show when showCenters is ON
      if (!el('showCenters').checked) return;
      viewer.addLabel(text, { position: p, backgroundOpacity: 0.6, fontSize: 14 });
    }

    function chainFromLabel(lbl){
      // Check if label contains "Protomer 2" to identify chain B
      return (lbl && lbl.includes('Protomer 2')) ? 'B' : 'A';
    }

    function addCenters(){
      const pts = RAW_CENTERS[state] || [];
      let centersCount = 0;
      pts.forEach(pt => {
        if (el('showCenters').checked) {
          const c = pt;
          const col = (chainFromLabel(c.label) === 'B') ? CHAIN_B : CHAIN_A;
          viewer.addSphere({
            center: {x:c.x, y:c.y, z:c.z},
            radius: 0.5,
            color: col,
            opacity: 0.9
          });
          distanceLabelAt(c.label, {x:c.x, y:c.y, z:c.z});
          centersCount++;
        }
      });
      return centersCount;
    }

    function startSpin(){ viewer.setSpin(true); }
    function stopSpin(){ viewer.setSpin(false); }

    function updateStatus(centersCount){
      status.textContent =
        "State: " + state +
        " · Style: " + (el('fastMode').checked ? "Fast (trace)" : "Cartoon") +
        " · Sidechains: " + (el('showSidechains').checked ? "ON" : "OFF") +
        " · Centers: " + (el('showCenters').checked ? centersCount + " shown" : centersCount + " (hidden)");
      if (el('spin').checked) startSpin();
    }

    function draw(){
      stopSpin();
      viewer.clear();
      let centersCount = 0;
      if (el('showPDB').checked) {
        const pdb = PDBS[state] || "";
        if (pdb.trim().length) {
          const m = viewer.addModel(pdb, "pdb");
          showProtein(m);
          if (el('showSidechains').checked) {
            try {
              showSidechains(m);
            } catch (e) {
              console.error("showSidechains error:", e);
            }
          }
        } else {
          viewer.addLabel("No PDB embedded for " + state, { fontSize: 16, backgroundOpacity: 0.6 });
        }
      }
      // Always call addCenters to allow labels to be shown independently
      centersCount = addCenters();
      viewer.zoomTo();
      viewer.render();
      updateStatus(centersCount);
    }

    el('state').onchange = ()=>{ state = el('state').value; draw(); };
    el('showPDB').onchange = draw;
    el('fastMode').onchange = draw;
    el('showCenters').onchange = draw;
    el('showSidechains').onchange = draw;
    el('showLabels').onchange = draw;
    el('spin').onchange = ()=> { if (el('spin').checked) startSpin(); else stopSpin(); };
    el('reset').onclick = () => {
      const btn = el('reset');

      // Visual feedback (blue flash)
      btn.classList.add('button-active');
      setTimeout(() => btn.classList.remove('button-active'), 200);

      // Re-draw the CURRENTLY selected state/model with current toggles
      draw();

      // Restore the baseline camera view captured on initial load
      if (baselineView) {
        viewer.setView(baselineView);
      }
      viewer.render();
    };

    // Two-finger touch pan/drag functionality and wheel-zoom code here...
    // (unchanged from your original script)

    // Initial draw and baseline view capture
    draw();
    viewer.rotate(180, {x:1, y:0, z:0});
    if (isMobileView()) {
      applyMobileViewAdjustments();
    }
    viewer.render();
    baselineView = viewer.getView();
  }
})();
</script>
</body>
</html>
